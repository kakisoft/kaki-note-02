---
slug: '/2021-08-07'
date: '2021-08-07'
title: 'ã€Laravelã€‘ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ã¤ã„ã¦æ•´ç†ã—ã¦ã¿ã‚‹ï¼—ï¼ˆã‚¸ãƒ§ãƒ–ï¼šdispatchIfï¼‰'
author: 'kakisoft'
tags: ['2021-08','laravel','batch']
description: ''
authorImg: ''
---

**ã€ ç’°å¢ƒ ã€‘**  
**Laravel ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼š 8.16.1**  
**PHP ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼š 7.4.7**  


## æ¡ä»¶ä»˜ãã§ã‚¸ãƒ§ãƒ–ã‚’ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã€ŒdispatchIf / dispatchUnlessã€
ã‚¸ãƒ§ãƒ–ã‚’ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã™ã‚‹æ™‚ã€ç™»éŒ²ã™ã‚‹ã‹ã©ã†ã‹ã‚’æ¡ä»¶ã§åˆ¤æ–­ã—ã¦ãã‚Œã‚‹ã€ŒdispatchIfã€ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹ã‚‰ã—ã„ã€‚

### dispatchIf / dispatchUnless
https://readouble.com/laravel/8.x/ja/queues.html  
https://laravel.com/docs/8.x/queues  

ä»¥ä¸‹ã€å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«ã‚½ãƒ¼ã‚¹ã€‚
```php
ProcessPodcast::dispatchIf($accountActive, $podcast);

ProcessPodcast::dispatchUnless($accountSuspended, $podcast);
```

ã—ã‹ã—ã€ã“ã‚Œã ã‘ã§ã¯ä½¿ã„æ–¹ãŒã•ã£ã±ã‚Šã€‚  

ã€ç¬¬ä¸€å¼•æ•°ã«ç„¡åé–¢æ•°ã‚’æ¸¡ã—ã€ãã‚Œã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦ã€true ã«ãªã£ãŸã‚‰ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²ã™ã‚‹ã€  
ã¨ã„ã†å‹•ãã‚’æœŸå¾…ã—ãŸãŒã€ç‰¹ã«èª¬æ˜ã¯ç„¡ã„ã¿ãŸã„ã ã€‚  

ã ã£ã¦ã€å˜ç´”ã«ã€Œç¬¬ä¸€å¼•æ•°ã« true ã‚’æ¸¡ã—ãŸã‚‰ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²ã€‚false ã‚’æ¸¡ã—ãŸã‚‰ç™»éŒ²ã—ãªã„ã€ã¨ã„ã†å‹•ä½œãªã‚‰ã€if æ–‡æ›¸ã‘ã°ã„ã„ã˜ã‚ƒãƒ¼ã‚“ã€‚ã‚ã–ã‚ã–ã“ã‚“ãªãƒ¡ã‚½ãƒƒãƒ‰ä½œã‚‹å¿…è¦ã­ãƒ¼ã‚ˆã€‚ã£ã¦æ€ã£ãŸã‹ã‚‰ã€‚  

ã‚³ãƒ¼ãƒ‰ã§è¨€ã†ã¨ã€ã“ã‚“ãªæ„Ÿã˜ã€‚
```php
if($accountActive){
    ProcessPodcast::dispatch($podcast);
}
```

## Laravel ã®ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚“ã§ã¿ã‚‹
å¤šåˆ†ã€ã“ã“ã€‚  

### framework\src\Illuminate\Foundation\Bus\Dispatchable.php
https://github.com/laravel/framework/blob/f13ae4cdec690028b9fab83c5e4cc140a80c042a/src/Illuminate/Foundation/Bus/Dispatchable.php#L27
```php
trait Dispatchable
{

//ï¼ˆä¸­ç•¥ï¼‰

    /**
     * Dispatch the job with the given arguments if the given truth test passes.
     *
     * @param  bool  $boolean
     * @param  mixed  ...$arguments
     * @return \Illuminate\Foundation\Bus\PendingDispatch|\Illuminate\Support\Fluent
     */
    public static function dispatchIf($boolean, ...$arguments)
    {
        return $boolean
            ? new PendingDispatch(new static(...$arguments))
            : new Fluent;
    }
```

ç¬¬ä¸€å¼•æ•°ã« true ã‚’æ¸¡ã›ã°ã‚¸ãƒ§ãƒ–ã«ã‚­ãƒ¥ãƒ¼ã‚’æ”¾ã‚Šè¾¼ã‚“ã§ãã‚Œãã†ãªæ°—ãŒã™ã‚‹ã‘ã©ã€false ã®æ™‚ã®å‹•ä½œãŒã‚¤ãƒã‚¤ãƒã‚ˆãåˆ†ã‹ã‚‰ãªã„ã€‚  

Fluent ã‚¯ãƒ©ã‚¹ã®æŒ™å‹•ãŒåˆ†ã‹ã‚Œã¯ãƒ”ãƒ³ã¨æ¥ã‚‹ã‚“ã ã‚ã†ã‘ã©ã€ä»Šã®è‡ªåˆ†ã«ã¯èª­ã‚“ã§ã‚‚ã•ã£ã±ã‚Šã€‚


## è©¦ã—ã«å‹•ã‹ã—ã¦ã¿ã‚‹
ç‰¹å®šã® URL ã‚’å©ã„ãŸã‚‰ dispatchIf ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ã¨ã„ã†æ¥µã‚ã¦ã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ã€‚

### routes\api.php
```php
// http://localhost:8000/api/dispatchIf-1
Route::get('dispatchIf-1', function(){
    \App\Jobs\MyJob01::dispatchIf(true);
    return 'dispatchIf-1';
});

// http://localhost:8000/api/dispatchIf-2
Route::get('dispatchIf-2', function(){
    \App\Jobs\MyJob01::dispatchIf(false);
    return 'dispatchIf-2';
});
```

ã‚­ãƒ¥ãƒ¼ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã—ãŸã€‚
```
|  id   |  queue    |  payload
|:------|:----------|:-----------------------------------------
|  1    |  default  |  {"uuid":"acded","displayName":"MyJob01",
```

ç¬¬ä¸€å¼•æ•°ã« true ã‚’æ¸¡ã—ãŸã‚¸ãƒ§ãƒ–ã¯ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²ã•ã‚Œã¦ã€false ã‚’æ¸¡ã—ãŸã‚¸ãƒ§ãƒ–ã¯ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã€‚  

ã†ã‚“ã€‚
**ä½•ãŒå¬‰ã—ã„ã‚“ã ã€‚ã“ã‚Œã€‚**  

æ™®é€šã« if æ–‡ã‚’ä½¿ã£ã¦åˆ†å²ã•ã›ã‚Œã°ã„ã„ã˜ã‚ƒã­ãƒ¼ã‹ã€‚  
ã‚‚ã—ãã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã§è¿”ã—ã¦ dispatch ã‚’å®Ÿè¡Œã—ãªã„ã¨ã‹ã€‚  

å­˜åœ¨æ„ç¾©ãŒåˆ†ã‹ã‚‰ã‚“ãƒ»ãƒ»ãƒ»  


## æœŸå¾…ã—ã¦ã„ãŸå‹•ã
ã€Œç¬¬ä¸€å¼•æ•°ã«ç„¡åé–¢æ•°ã‚’æ¸¡ã™ã€‚ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã€false ã‚’è¿”ã—ã¦ã„ã‚‹é–“ã¯ã‚­ãƒ¥ãƒ¼ã«ã‚¸ãƒ§ãƒ–ã‚’ç™»éŒ²ã—ãªã„ã‘ã©ã€  
true ã‚’è¿”ã™ã‚ˆã†ã«ãªã£ãŸã‚‰ç™»éŒ²ã™ã‚‹ã€  

ã¨ã„ã†å‹•ãã€‚  

ã‚³ãƒ¼ãƒ‰ã§æ›¸ãã¨ã€ã“ã‚“ãªæ„Ÿã˜ã€‚
```php
$isSomeJobFinished = function ($id) {
    $jobStatus = App\Models\JobStatuses::find($id);
    return $jobStatus['is_finished'];
};


// http://localhost:8000/api/dispatchIf-3
Route::get('dispatchIf-3', function(){
    \App\Jobs\MyJob01::dispatchIf($isSomeJobFinished(1));
    return 'dispatchIf-3';
});
```

ã“ã‚“ãªæ„Ÿã˜ã«æ›¸ã„ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã¯ãªã‚‰ãªã‹ã£ãŸã—ã€ä½•ãªã‚‰æ­£å¸¸ã«å‹•ã„ãŸã‚“ã ã‘ã©ã€  
ã—ã°ã‚‰ãã—ã¦ true ã‚’è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã‚‚ã€ã‚¸ãƒ§ãƒ–ãŒç™»éŒ²ã•ã‚Œã‚‹ã€ã¨ã„ã†å‹•ãã¯ç„¡ã‹ã£ãŸã€‚  

ä½•ã®ãŸã‚ã«å­˜åœ¨ã—ã¨ã‚“ã­ã‚“ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã€‚  

## å¾Œæ—¥è«‡ï¼‘
å…¨ãåŒã˜ç–‘å•ã‚’æŒã£ãŸäººãŒã„ãŸã€‚  
https://github.com/laravel/ideas/issues/1587  

ã“ã® issue ã¯ã™ã§ã« close ã ã‘ã©ã€è‡ªåˆ†ãŒã“ã®è­°è«–ã«å‚åŠ ã—ã¦ãŸã‚‰ã€sisve ã•ã‚“ã®æ„è¦‹ã« 100å›ğŸ‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã€‚

## å¾Œæ—¥è«‡ï¼’
ã›ã£ã‹ãã“ã“ã¾ã§æ˜ã‚Šä¸‹ã’ãŸã‚“ã§ã€Laravel ã® github ã« issue ã‚’ç«‹ã¦ã¦ã¿ã‚ˆã†ã¨æ€ã£ãŸã€‚  

ãŒã€ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’èª­ã‚€ã¨ã€ã€Œã“ã“ã§è­°è«–ã™ã‚‹å‰ã«ã€ã“ã‚Œã¨ã‹ã“ã‚Œã¨ã“ã‚Œã§è©±ã—ã¦è§£æ±ºã•ã›ãƒ¼ã‚„ã€ã¿ãŸã„äº‹ãŒæ›¸ã„ã¦ã‚ã£ãŸã®ã§ã€ä»•æ–¹ãªã stackoverflow ã«æŠ•ç¨¿ã€‚  
https://stackoverflow.com/questions/68730299/what-is-effective-way-of-use-dispatchif-method-in-queue  

